---
# main tasks file for otvl_service/k3s/control/configure

- name: combine default with actual otvl config data
  set_fact:
    combined_otvl: "{{ default_otvl | combine(otvl, recursive=True) }}"

- name: Configure access to k3s api server
  ansible.builtin.copy:
    src: "/home/{{ combined_otvl.config_vars.devops_user }}/.k3s/{{ combined_otvl.k3s.api_server }}/srv/data/otvl/k3s/k3s.yaml"
    remote_src: true
    dest: "/home/{{ combined_otvl.config_vars.devops_user }}/.kube/config"
    mode: "0600"

- name: Create a StorageClass for single node local storage
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: otvl-single-node-local-storage
      provisioner: kubernetes.io/no-provisioner
      volumeBindingMode: WaitForFirstConsumer

- name: Install traefik k8s IngressRoute CRD and RBAC
  block:
    - command:
        cmd: "kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v2.10/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml"
      register: kapply
    - debug: var=kapply.cmd
    - debug: var=kapply.stderr_lines
    - debug: var=kapply.stdout_lines
    - command:
        cmd: "kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v2.10/docs/content/reference/dynamic-configuration/kubernetes-crd-rbac.yml"
      register: kapply
    - debug: var=kapply.cmd
    - debug: var=kapply.stderr_lines
    - debug: var=kapply.stdout_lines

###